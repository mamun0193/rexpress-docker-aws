name: Deploy rexpress to ECS

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  FRONTEND_REPO: rexpress-frontend
  BACKEND_REPO: rexpress-backend
  CLUSTER_NAME: rexpress-cluster
  FRONTEND_SERVICE: rexpress-frontend-service
  BACKEND_SERVICE: rexpress-backend-service

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
          | docker login --username AWS --password-stdin $ECR_REGISTRY

      - name: Set image tag
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
          else
            IMAGE_TAG="${GITHUB_SHA::7}"
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "Using IMAGE_TAG=$IMAGE_TAG"

      - name: Build & Push Backend Image
        run: |
          docker build -t $BACKEND_REPO:$IMAGE_TAG -t $BACKEND_REPO:latest ./backend
          docker tag $BACKEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$BACKEND_REPO:$IMAGE_TAG
          docker tag $BACKEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$BACKEND_REPO:latest
          docker push $ECR_REGISTRY/$BACKEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$BACKEND_REPO:latest
          echo "Backend images pushed: $ECR_REGISTRY/$BACKEND_REPO:$IMAGE_TAG and latest"

      - name: Build & Push Frontend Image
        run: |
          docker build -t $FRONTEND_REPO:$IMAGE_TAG -t $FRONTEND_REPO:latest ./frontend
          docker tag $FRONTEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$FRONTEND_REPO:$IMAGE_TAG
          docker tag $FRONTEND_REPO:$IMAGE_TAG $ECR_REGISTRY/$FRONTEND_REPO:latest
          docker push $ECR_REGISTRY/$FRONTEND_REPO:$IMAGE_TAG
          docker push $ECR_REGISTRY/$FRONTEND_REPO:latest
          echo "Frontend images pushed: $ECR_REGISTRY/$FRONTEND_REPO:$IMAGE_TAG and latest"

      - name: Pre-deployment smoke tests
        run: |
          set -e
          echo "Running pre-deployment smoke tests using image tag $IMAGE_TAG"
          docker pull $ECR_REGISTRY/$BACKEND_REPO:$IMAGE_TAG
          docker pull $ECR_REGISTRY/$FRONTEND_REPO:$IMAGE_TAG

          docker run -d --name smoke-backend -p 5000:5000 $ECR_REGISTRY/$BACKEND_REPO:$IMAGE_TAG
          sleep 5
          curl --retry 5 --retry-delay 2 -f http://localhost:5000/health
          echo "Backend smoke test passed"

          docker run -d --name smoke-frontend -p 8080:80 $ECR_REGISTRY/$FRONTEND_REPO:$IMAGE_TAG
          sleep 5
          curl --retry 5 --retry-delay 2 -f http://localhost:8080
          echo "Frontend smoke test passed"

          docker stop smoke-backend smoke-frontend || true
          docker rm smoke-backend smoke-frontend || true
          echo "Smoke tests completed"

      - name: Update Backend ECS Service
        run: |
          aws ecs update-service \
            --cluster $CLUSTER_NAME \
            --service $BACKEND_SERVICE \
            --force-new-deployment \
            --region $AWS_REGION
          echo "Backend service deployment triggered"

      - name: Update Frontend ECS Service
        run: |
          aws ecs update-service \
            --cluster $CLUSTER_NAME \
            --service $FRONTEND_SERVICE \
            --force-new-deployment \
            --region $AWS_REGION
          echo "Frontend service deployment triggered"

      - name: Wait for deployments
        run: |
          echo "Waiting for services to stabilize..."
          sleep 30
          
          aws ecs wait services-stable \
            --cluster $CLUSTER_NAME \
            --services $BACKEND_SERVICE $FRONTEND_SERVICE \
            --region $AWS_REGION || true
          
          echo "Deployment complete!"
